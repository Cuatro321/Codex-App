<!-- src/app/pages/perfil/perfil.page.html -->
<ion-header translucent="true">
  <ion-toolbar class="nexo-toolbar">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title class="nexo-brand">Mi Perfil</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="perfil-page" fullscreen="true">
  <div class="ion-padding">
    <!-- SI HAY USUARIO: PERFIL + EDICIÓN -->
    <ng-container *ngIf="user$ | async as user; else authForm">
      <!-- Cabecera -->
      <div class="profile-header">
        <div class="profile-main">
          <div class="profile-avatar">
            <ng-container *ngIf="avatarPreviewUrl; else avatarDefault">
              <img [src]="avatarPreviewUrl" alt="Avatar" />
            </ng-container>
            <ng-template #avatarDefault>
              <ion-icon name="person-circle-outline"></ion-icon>
            </ng-template>
          </div>

          <div>
            <div class="profile-label">Cuenta del Nexo</div>
            <div class="profile-name">
              {{ displayName || user.email }}
            </div>
            <div class="profile-meta">
              <ion-badge color="success">Conectado al Nexo</ion-badge>
            </div>
          </div>
        </div>
      </div>

      <!-- Editor de perfil -->
      <div class="profile-editor">
        <!-- Columna izquierda -->
        <div class="editor-card editor-card--left">
          <h3 class="section-title">Perfil público</h3>
          <p class="section-subtitle">
            Esta información se mostrará a otros viajeros del Nexo.
          </p>

          <div class="avatar-edit">
            <div class="avatar-preview">
              <ng-container *ngIf="avatarPreviewUrl; else avatarIcon">
                <img [src]="avatarPreviewUrl" alt="Avatar" />
              </ng-container>
              <ng-template #avatarIcon>
                <ion-icon name="person-circle-outline"></ion-icon>
              </ng-template>
            </div>

            <div class="avatar-actions">
              <p class="hint">JPG/PNG, recomendado 512×512px.</p>

              <input
                #avatarInput
                type="file"
                accept="image/*"
                hidden
                (change)="onAvatarSelected($event)"
              />

              <ion-button size="small" (click)="avatarInput.click()">
                Cambiar imagen
              </ion-button>

              <ion-item lines="none" class="remove-avatar">
                <ion-checkbox
                  slot="start"
                  [(ngModel)]="removeAvatar"
                ></ion-checkbox>
                <ion-label>Quitar avatar</ion-label>
              </ion-item>
            </div>
          </div>

          <ion-item lines="none" class="field-item">
            <ion-label position="stacked">Nombre para mostrar</ion-label>
            <ion-input
              [(ngModel)]="displayName"
              placeholder="Cómo te verán otros jugadores"
            ></ion-input>
          </ion-item>
          <p class="field-hint">Aparecerá en la comunidad y en el chat.</p>

          <ion-item lines="none" class="field-item">
            <ion-label position="stacked">Bio</ion-label>
            <ion-textarea
              autoGrow="true"
              rows="3"
              [(ngModel)]="bio"
              placeholder="Cuenta quién eres dentro del Nexo..."
            ></ion-textarea>
          </ion-item>
          <p class="field-hint">
            Una breve descripción de tu guardián del Nexo.
          </p>
        </div>

        <!-- Columna derecha -->
        <div class="editor-card editor-card--right">
          <h3 class="section-title">Información básica</h3>
          <p class="section-subtitle">
            Ubicación del eco. Se muestra junto a tu perfil.
          </p>

          <ion-item lines="none" class="field-item">
            <ion-label position="stacked">Ciudad</ion-label>
            <ion-input
              [(ngModel)]="city"
              placeholder="Ej. Neo Ciudad, El Nexo"
            ></ion-input>
          </ion-item>

          <ion-item lines="none" class="field-item">
            <ion-label position="stacked">País</ion-label>
            <ion-input
              [(ngModel)]="country"
              placeholder="Ej. NexoPaís"
            ></ion-input>
          </ion-item>

          <div class="buttons-row">
            <ion-button
              expand="block"
              color="warning"
              (click)="onSaveProfile(user)"
              [disabled]="profileSaveLoading"
              class="btn-save-nexo"
            >
              <ion-spinner
                *ngIf="profileSaveLoading"
                name="crescent"
                slot="start"
              ></ion-spinner>
              Guardar cambios
            </ion-button>
          </div>

          <div class="profile-messages">
            <p class="profile-error" *ngIf="profileError">
              {{ profileError }}
            </p>
            <p class="profile-ok" *ngIf="profileMessage">
              {{ profileMessage }}
            </p>
          </div>

          <div class="logout-wrapper">
            <ion-button
              expand="block"
              color="danger"
              (click)="logout()"
            >
              Cerrar sesión
            </ion-button>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- SI NO HAY USUARIO: FORMULARIO LOGIN / REGISTRO -->
    <ng-template #authForm>
      <div class="auth-card">
        <h2 class="auth-title">Accede al Nexo</h2>
        <p class="auth-subtitle">
          Usa tu correo y una contraseña para entrar o forjar una nueva cuenta.
        </p>

        <ion-segment [(ngModel)]="mode" value="login" class="auth-segment">
          <ion-segment-button value="login">
            <ion-label>Iniciar sesión</ion-label>
          </ion-segment-button>
          <ion-segment-button value="register">
            <ion-label>Crear cuenta</ion-label>
          </ion-segment-button>
        </ion-segment>

        <ion-list lines="none" class="auth-form">
          <ion-item class="auth-field">
            <ion-icon slot="start" name="mail-outline"></ion-icon>
            <ion-label position="stacked">Correo electrónico</ion-label>
            <ion-input
              type="email"
              [(ngModel)]="email"
              placeholder="eco@nexo.com"
            ></ion-input>
          </ion-item>

          <ion-item class="auth-field">
            <ion-icon slot="start" name="lock-closed-outline"></ion-icon>
            <ion-label position="stacked">Contraseña</ion-label>
            <ion-input
              type="password"
              [(ngModel)]="password"
              placeholder="Escribe tu contraseña"
            ></ion-input>
          </ion-item>
        </ion-list>

        <div *ngIf="errorMessage" class="error-text">
          {{ errorMessage }}
        </div>

        <ion-button
          class="auth-btn"
          expand="block"
          color="warning"
          (click)="submit()"
          [disabled]="loading"
        >
          {{ mode === 'login' ? 'Entrar' : 'Crear cuenta' }}
        </ion-button>
      </div>
    </ng-template>
  </div>
</ion-content>
